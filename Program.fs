open System
open System.IO
open System.Text

let generaTemplateHex =
    let tmpl = [|
        "3C"; "3F"; "78"; "6D"; "6C"; "20"; "76"; "65"; "72"; "73"; "69"; "6F"; "6E"; "3D"; "22"; "31"; "2E"; "30"; "22"; "20"; "65"; "6E"; "63"; "6F"; "64"; "69"; "6E"; "67"; "3D"; "22"; "55"; "54"; "46"; "2D"; "38"; "22"; "3F"; "3E"; "0A"; "3C"; "71"; "75"; "69"; "7A"; "3E"; "0A"; "20"; "20"; "3C"; "21"; "2D"; "2D"; "20"; "71"; "75"; "65"; "73"; "74"; "69"; "6F"; "6E"; "3A"; "20"; "30"; "20"; "20"; "2D"; "2D"; "3E"; "0A"; "20"; "20"; "3C"; "71"; "75"; "65"; "73"; "74"; "69"; "6F"; "6E"; "20"; "74"; "79"; "70"; "65"; "3D"; "22"; "63"; "6F"; "64"; "65"; "72"; "75"; "6E"; "6E"; "65"; "72"; "22"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "6E"; "61"; "6D"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "78"; "74"; "3E"; "3C"; "21"; "5B"; "43"; "44"; "41"; "54"; "41"; "5B"; "5D"; "5D"; "3E"; "3C"; "2F"; "74"; "65"; "78"; "74"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "2F"; "6E"; "61"; "6D"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "71"; "75"; "65"; "73"; "74"; "69"; "6F"; "6E"; "74"; "65"; "78"; "74"; "20"; "66"; "6F"; "72"; "6D"; "61"; "74"; "3D"; "22"; "68"; "74"; "6D"; "6C"; "22"; "3E"; "0A"; "20"; "20"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "78"; "74"; "3E"; "3C"; "21"; "5B"; "43"; "44"; "41"; "54"; "41"; "5B"; "5D"; "5D"; "3E"; "3C"; "2F"; "74"; "65"; "78"; "74"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "2F"; "71"; "75"; "65"; "73"; "74"; "69"; "6F"; "6E"; "74"; "65"; "78"; "74"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "67"; "65"; "6E"; "65"; "72"; "61"; "6C"; "66"; "65"; "65"; "64"; "62"; "61"; "63"; "6B"; "20"; "66"; "6F"; "72"; "6D"; "61"; "74"; "3D"; "22"; "68"; "74"; "6D"; "6C"; "22"; "3E"; "0A"; "20"; "20"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "78"; "74"; "3E"; "3C"; "21"; "5B"; "43"; "44"; "41"; "54"; "41"; "5B"; "5D"; "5D"; "3E"; "3C"; "2F"; "74"; "65"; "78"; "74"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "2F"; "67"; "65"; "6E"; "65"; "72"; "61"; "6C"; "66"; "65"; "65"; "64"; "62"; "61"; "63"; "6B"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "64"; "65"; "66"; "61"; "75"; "6C"; "74"; "67"; "72"; "61"; "64"; "65"; "3E"; "31"; "3C"; "2F"; "64"; "65"; "66"; "61"; "75"; "6C"; "74"; "67"; "72"; "61"; "64"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "70"; "65"; "6E"; "61"; "6C"; "74"; "79"; "3E"; "30"; "3C"; "2F"; "70"; "65"; "6E"; "61"; "6C"; "74"; "79"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "68"; "69"; "64"; "64"; "65"; "6E"; "3E"; "30"; "3C"; "2F"; "68"; "69"; "64"; "64"; "65"; "6E"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "69"; "64"; "6E"; "75"; "6D"; "62"; "65"; "72"; "3E"; "3C"; "2F"; "69"; "64"; "6E"; "75"; "6D"; "62"; "65"; "72"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "63"; "6F"; "64"; "65"; "72"; "75"; "6E"; "6E"; "65"; "72"; "74"; "79"; "70"; "65"; "3E"; "3C"; "2F"; "63"; "6F"; "64"; "65"; "72"; "75"; "6E"; "6E"; "65"; "72"; "74"; "79"; "70"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "70"; "72"; "6F"; "74"; "6F"; "74"; "79"; "70"; "65"; "74"; "79"; "70"; "65"; "3E"; "30"; "3C"; "2F"; "70"; "72"; "6F"; "74"; "6F"; "74"; "79"; "70"; "65"; "74"; "79"; "70"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "61"; "6C"; "6C"; "6F"; "72"; "6E"; "6F"; "74"; "68"; "69"; "6E"; "67"; "3E"; "31"; "3C"; "2F"; "61"; "6C"; "6C"; "6F"; "72"; "6E"; "6F"; "74"; "68"; "69"; "6E"; "67"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "70"; "65"; "6E"; "61"; "6C"; "74"; "79"; "72"; "65"; "67"; "69"; "6D"; "65"; "3E"; "31"; "30"; "2C"; "20"; "32"; "30"; "2C"; "20"; "2E"; "2E"; "2E"; "3C"; "2F"; "70"; "65"; "6E"; "61"; "6C"; "74"; "79"; "72"; "65"; "67"; "69"; "6D"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "70"; "72"; "65"; "63"; "68"; "65"; "63"; "6B"; "3E"; "30"; "3C"; "2F"; "70"; "72"; "65"; "63"; "68"; "65"; "63"; "6B"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "68"; "69"; "64"; "65"; "63"; "68"; "65"; "63"; "6B"; "3E"; "30"; "3C"; "2F"; "68"; "69"; "64"; "65"; "63"; "68"; "65"; "63"; "6B"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "73"; "68"; "6F"; "77"; "73"; "6F"; "75"; "72"; "63"; "65"; "3E"; "30"; "3C"; "2F"; "73"; "68"; "6F"; "77"; "73"; "6F"; "75"; "72"; "63"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "61"; "6E"; "73"; "77"; "65"; "72"; "62"; "6F"; "78"; "6C"; "69"; "6E"; "65"; "73"; "3E"; "31"; "38"; "3C"; "2F"; "61"; "6E"; "73"; "77"; "65"; "72"; "62"; "6F"; "78"; "6C"; "69"; "6E"; "65"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "61"; "6E"; "73"; "77"; "65"; "72"; "62"; "6F"; "78"; "63"; "6F"; "6C"; "75"; "6D"; "6E"; "73"; "3E"; "31"; "30"; "30"; "3C"; "2F"; "61"; "6E"; "73"; "77"; "65"; "72"; "62"; "6F"; "78"; "63"; "6F"; "6C"; "75"; "6D"; "6E"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "61"; "6E"; "73"; "77"; "65"; "72"; "70"; "72"; "65"; "6C"; "6F"; "61"; "64"; "3E"; "3C"; "21"; "5B"; "43"; "44"; "41"; "54"; "41"; "5B"; "5D"; "5D"; "3E"; "3C"; "2F"; "61"; "6E"; "73"; "77"; "65"; "72"; "70"; "72"; "65"; "6C"; "6F"; "61"; "64"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "67"; "6C"; "6F"; "62"; "61"; "6C"; "65"; "78"; "74"; "72"; "61"; "3E"; "3C"; "2F"; "67"; "6C"; "6F"; "62"; "61"; "6C"; "65"; "78"; "74"; "72"; "61"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "75"; "73"; "65"; "61"; "63"; "65"; "3E"; "3C"; "2F"; "75"; "73"; "65"; "61"; "63"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "72"; "65"; "73"; "75"; "6C"; "74"; "63"; "6F"; "6C"; "75"; "6D"; "6E"; "73"; "3E"; "3C"; "2F"; "72"; "65"; "73"; "75"; "6C"; "74"; "63"; "6F"; "6C"; "75"; "6D"; "6E"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "3E"; "3C"; "2F"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "69"; "73"; "63"; "6F"; "6D"; "62"; "69"; "6E"; "61"; "74"; "6F"; "72"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "3E"; "3C"; "2F"; "69"; "73"; "63"; "6F"; "6D"; "62"; "69"; "6E"; "61"; "74"; "6F"; "72"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "61"; "6C"; "6C"; "6F"; "77"; "6D"; "75"; "6C"; "74"; "69"; "70"; "6C"; "65"; "73"; "74"; "64"; "69"; "6E"; "73"; "3E"; "3C"; "2F"; "61"; "6C"; "6C"; "6F"; "77"; "6D"; "75"; "6C"; "74"; "69"; "70"; "6C"; "65"; "73"; "74"; "64"; "69"; "6E"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "61"; "6E"; "73"; "77"; "65"; "72"; "3E"; "3C"; "21"; "5B"; "43"; "44"; "41"; "54"; "41"; "5B"; "5D"; "5D"; "3E"; "3C"; "2F"; "61"; "6E"; "73"; "77"; "65"; "72"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "76"; "61"; "6C"; "69"; "64"; "61"; "74"; "65"; "6F"; "6E"; "73"; "61"; "76"; "65"; "3E"; "31"; "3C"; "2F"; "76"; "61"; "6C"; "69"; "64"; "61"; "74"; "65"; "6F"; "6E"; "73"; "61"; "76"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "73"; "74"; "73"; "70"; "6C"; "69"; "74"; "74"; "65"; "72"; "72"; "65"; "3E"; "3C"; "2F"; "74"; "65"; "73"; "74"; "73"; "70"; "6C"; "69"; "74"; "74"; "65"; "72"; "72"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "6C"; "61"; "6E"; "67"; "75"; "61"; "67"; "65"; "3E"; "3C"; "2F"; "6C"; "61"; "6E"; "67"; "75"; "61"; "67"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "61"; "63"; "65"; "6C"; "61"; "6E"; "67"; "3E"; "3C"; "2F"; "61"; "63"; "65"; "6C"; "61"; "6E"; "67"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "73"; "61"; "6E"; "64"; "62"; "6F"; "78"; "3E"; "3C"; "2F"; "73"; "61"; "6E"; "64"; "62"; "6F"; "78"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "67"; "72"; "61"; "64"; "65"; "72"; "3E"; "3C"; "2F"; "67"; "72"; "61"; "64"; "65"; "72"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "63"; "70"; "75"; "74"; "69"; "6D"; "65"; "6C"; "69"; "6D"; "69"; "74"; "73"; "65"; "63"; "73"; "3E"; "3C"; "2F"; "63"; "70"; "75"; "74"; "69"; "6D"; "65"; "6C"; "69"; "6D"; "69"; "74"; "73"; "65"; "63"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "6D"; "65"; "6D"; "6C"; "69"; "6D"; "69"; "74"; "6D"; "62"; "3E"; "3C"; "2F"; "6D"; "65"; "6D"; "6C"; "69"; "6D"; "69"; "74"; "6D"; "62"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "73"; "61"; "6E"; "64"; "62"; "6F"; "78"; "70"; "61"; "72"; "61"; "6D"; "73"; "3E"; "3C"; "2F"; "73"; "61"; "6E"; "64"; "62"; "6F"; "78"; "70"; "61"; "72"; "61"; "6D"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "3E"; "3C"; "2F"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "68"; "6F"; "69"; "73"; "74"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "3E"; "31"; "3C"; "2F"; "68"; "6F"; "69"; "73"; "74"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "65"; "78"; "74"; "72"; "61"; "63"; "74"; "63"; "6F"; "64"; "65"; "66"; "72"; "6F"; "6D"; "6A"; "73"; "6F"; "6E"; "3E"; "31"; "3C"; "2F"; "65"; "78"; "74"; "72"; "61"; "63"; "74"; "63"; "6F"; "64"; "65"; "66"; "72"; "6F"; "6D"; "6A"; "73"; "6F"; "6E"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "6C"; "61"; "6E"; "67"; "3E"; "4E"; "6F"; "6E"; "65"; "3C"; "2F"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "6C"; "61"; "6E"; "67"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "65"; "76"; "61"; "6C"; "70"; "65"; "72"; "74"; "72"; "79"; "3E"; "30"; "3C"; "2F"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "65"; "76"; "61"; "6C"; "70"; "65"; "72"; "74"; "72"; "79"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "65"; "76"; "61"; "6C"; "64"; "3E"; "7B"; "7D"; "3C"; "2F"; "74"; "65"; "6D"; "70"; "6C"; "61"; "74"; "65"; "70"; "61"; "72"; "61"; "6D"; "73"; "65"; "76"; "61"; "6C"; "64"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "74"; "77"; "69"; "67"; "61"; "6C"; "6C"; "3E"; "30"; "3C"; "2F"; "74"; "77"; "69"; "67"; "61"; "6C"; "6C"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "75"; "69"; "70"; "6C"; "75"; "67"; "69"; "6E"; "3E"; "3C"; "2F"; "75"; "69"; "70"; "6C"; "75"; "67"; "69"; "6E"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "75"; "69"; "70"; "61"; "72"; "61"; "6D"; "65"; "74"; "65"; "72"; "73"; "3E"; "3C"; "2F"; "75"; "69"; "70"; "61"; "72"; "61"; "6D"; "65"; "74"; "65"; "72"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "61"; "74"; "74"; "61"; "63"; "68"; "6D"; "65"; "6E"; "74"; "73"; "3E"; "30"; "3C"; "2F"; "61"; "74"; "74"; "61"; "63"; "68"; "6D"; "65"; "6E"; "74"; "73"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "61"; "74"; "74"; "61"; "63"; "68"; "6D"; "65"; "6E"; "74"; "73"; "72"; "65"; "71"; "75"; "69"; "72"; "65"; "64"; "3E"; "30"; "3C"; "2F"; "61"; "74"; "74"; "61"; "63"; "68"; "6D"; "65"; "6E"; "74"; "73"; "72"; "65"; "71"; "75"; "69"; "72"; "65"; "64"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "6D"; "61"; "78"; "66"; "69"; "6C"; "65"; "73"; "69"; "7A"; "65"; "3E"; "31"; "30"; "32"; "34"; "30"; "3C"; "2F"; "6D"; "61"; "78"; "66"; "69"; "6C"; "65"; "73"; "69"; "7A"; "65"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "66"; "69"; "6C"; "65"; "6E"; "61"; "6D"; "65"; "73"; "72"; "65"; "67"; "65"; "78"; "3E"; "3C"; "2F"; "66"; "69"; "6C"; "65"; "6E"; "61"; "6D"; "65"; "73"; "72"; "65"; "67"; "65"; "78"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "66"; "69"; "6C"; "65"; "6E"; "61"; "6D"; "65"; "73"; "65"; "78"; "70"; "6C"; "61"; "69"; "6E"; "3E"; "3C"; "2F"; "66"; "69"; "6C"; "65"; "6E"; "61"; "6D"; "65"; "73"; "65"; "78"; "70"; "6C"; "61"; "69"; "6E"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "64"; "69"; "73"; "70"; "6C"; "61"; "79"; "66"; "65"; "65"; "64"; "62"; "61"; "63"; "6B"; "3E"; "31"; "3C"; "2F"; "64"; "69"; "73"; "70"; "6C"; "61"; "79"; "66"; "65"; "65"; "64"; "62"; "61"; "63"; "6B"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "67"; "69"; "76"; "65"; "75"; "70"; "61"; "6C"; "6C"; "6F"; "77"; "65"; "64"; "3E"; "30"; "3C"; "2F"; "67"; "69"; "76"; "65"; "75"; "70"; "61"; "6C"; "6C"; "6F"; "77"; "65"; "64"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "70"; "72"; "6F"; "74"; "6F"; "74"; "79"; "70"; "65"; "65"; "78"; "74"; "72"; "61"; "3E"; "3C"; "2F"; "70"; "72"; "6F"; "74"; "6F"; "74"; "79"; "70"; "65"; "65"; "78"; "74"; "72"; "61"; "3E"; "0A"; "20"; "20"; "20"; "20"; "3C"; "74"; "65"; "73"; "74"; "63"; "61"; "73"; "65"; "73"; "3E"; "3C"; "2F"; "74"; "65"; "73"; "74"; "63"; "61"; "73"; "65"; "73"; "3E"; "0A"; "20"; "20"; "3C"; "2F"; "71"; "75"; "65"; "73"; "74"; "69"; "6F"; "6E"; "3E"; "0A"; "0A"; "3C"; "2F"; "71"; "75"; "69"; "7A"; "3E"|]
    tmpl

let HexToAscii (hex:string) =
    try
        let num = Convert.ToInt32(hex, 16)
        char num
    with
        | :? FormatException ->
            printfn "Formato hex non valido!"
            '\u0000'
        | :? OverflowException ->
            printfn "Numero hex troppo grande!"
            '\u0000'
        | e ->
            printfn "Errore sconosciuto!"
            '\u0000'

let letturaFile (percorso:string) : string =
    try
        let contenuto = File.ReadAllText(percorso)
        contenuto
    with
        | :? IOException as e ->
            e.Message
        | e ->
            e.Message

let inserisciTesto (testo:string) (aggiunta:string) (posizione:int) : string =
    if posizione < 0 || posizione > testo.Length then
        printfn "Errore: posizione al di fuori dei limiti del testo"
        testo
    else
        let sx = testo.Substring(0, posizione)
        let dx = testo.Substring(posizione)
        sx + aggiunta + dx

[<EntryPoint>]

let main argv =

    let templateHexArray = generaTemplateHex

    let caratteriAscii =
        templateHexArray
        |> Array.map HexToAscii
        |> Array.filter (fun c -> c <> '\u0000') // filtraggio caratteri nulli

    let asciiString = new string(caratteriAscii)

    let percorsoFileOut = "out.xml"

    let testoConsegna = (letturaFile "consegna.txt")
    let testoCodice = (letturaFile "codice.txt")

    let insConsegna = inserisciTesto asciiString testoConsegna 133
    let insCodice = inserisciTesto insConsegna testoCodice (1053 + testoConsegna.Length)

    try
        File.WriteAllText(percorsoFileOut, insCodice)
    with
        | :? UnauthorizedAccessException ->
        printfn "Accesso negato al percorso '%s'." percorsoFileOut
        | :? DirectoryNotFoundException ->
            printfn "Il file specificato '%s' non esiste." percorsoFileOut
        | :? IOException as ex ->
            printfn "Errore di I/O durante la scrittura del file: %s" ex.Message
        | ex ->
            printfn "Si è verificato un errore inatteso: %s" ex.Message


    0